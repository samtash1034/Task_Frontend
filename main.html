<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>任務與使用者管理系統</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
      body {
        background-color: #f0f2f5;
        font-family: "微軟正黑體", sans-serif;
      }
      .sidebar {
        height: 100vh;
        padding-top: 40px;
        background-color: #ffffff;
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
      }
      .menu-button {
        width: 100%;
        margin-bottom: 12px;
        font-weight: 600;
        border-radius: 8px;
        transition: background-color 0.3s;
      }
      .menu-button:hover {
        background-color: #0d6efd;
        color: white;
      }
      .main-content {
        padding: 40px 50px;
      }
      h2 {
        font-weight: 700;
        margin-bottom: 30px;
        color: #343a40;
      }
      .card {
        border-radius: 12px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
      }
      table th,
      table td {
        vertical-align: middle !important;
      }
      table thead {
        background-color: #0d6efd;
        color: white;
      }
      table tbody tr:hover {
        background-color: #e7f1ff;
      }
      button.btn-sm {
        border-radius: 6px;
      }
      /* 表單樣式 */
      label {
        font-weight: 600;
      }
      input.form-control:focus,
      select.form-select:focus {
        box-shadow: 0 0 5px #0d6efd;
        border-color: #0d6efd;
      }
      /* 必填標示 */
      .required::after {
        content: " *";
        color: #dc3545;
        font-weight: 700;
      }

      /* 任務看板樣式 */
      .task-board {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background: white;
      }
      .task-header {
        background-color: #f8f9fa;
        padding: 15px 20px;
        border-bottom: 1px solid #e0e0e0;
        font-weight: 600;
        color: #495057;
      }
      .task-row {
        display: flex;
        align-items: center;
        padding: 12px 20px;
        border-bottom: 1px solid #f0f0f0;
        min-height: 60px;
      }
      .task-row:hover {
        background-color: #f8f9fa;
      }
      .task-checkbox {
        width: 18px;
        height: 18px;
        margin-right: 15px;
      }
      .task-name {
        flex: 1;
        font-size: 16px;
        border: none;
        background: transparent;
        padding: 5px;
        border-radius: 4px;
      }
      .task-name:focus {
        background-color: #fff;
        border: 1px solid #0d6efd;
        outline: none;
      }
      .task-owner {
        width: 150px;
        text-align: center;
        color: #6c757d;
      }
      .task-status {
        width: 200px;
        position: relative;
      }
      .status-badge {
        display: inline-block;
        padding: 6px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        width: 140px;
        text-align: center;
      }
      .status-ready {
        background-color: #6c757d;
        color: white;
      }
      .status-progress {
        background-color: #ffc107;
        color: #212529;
      }
      .status-done {
        background-color: #198754;
        color: white;
      }
      .status-stuck {
        background-color: #dc3545;
        color: white;
      }
      .status-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        margin-top: 5px;
      }
      .status-option {
        padding: 8px 16px;
        cursor: pointer;
        transition: background-color 0.2s;
        border-radius: 6px;
        margin: 4px;
        font-size: 14px;
      }
      .status-option:hover {
        background-color: #f0f0f0;
      }
      .add-task-row {
        padding: 15px 20px;
        color: #6c757d;
        border-bottom: none;
      }
      .add-task-row input:focus {
        color: #495057;
        background-color: #fff;
      }
      .task-actions {
        width: 80px;
        text-align: center;
      }
      .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background-color: #e9ecef;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
        font-size: 14px;
        font-weight: 500;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <!-- 左側選單 -->
        <div class="col-md-2 sidebar">
          <h5 class="text-center mb-4">功能選單</h5>
          <div id="menu-area"></div>
        </div>

        <!-- 主內容區 -->
        <div class="col-md-10 main-content">
          <h2 class="text-center">任務與使用者管理系統</h2>
          <div class="card mt-4">
            <div class="card-body">
              <div id="content"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const token = localStorage.getItem("token");
      if (!token) {
        window.location.href = "login.html";
      }

      const axiosConfig = {
        headers: {
          Authorization: `Bearer ${token}`,
        },
      };

      let userList = [];
      let taskList = [];

      // 狀態選項配置
      const statusOptions = [
        { value: 0, label: "未開始", class: "status-ready" },
        { value: 1, label: "進行中", class: "status-progress" },
        { value: 2, label: "已完成", class: "status-done" },
        { value: 3, label: "終止", class: "status-stuck" },
      ];

      axios
        .get("http://localhost:8080/api/menu", axiosConfig)
        .then((res) => {
          const menus = res.data.result;
          const menuArea = document.getElementById("menu-area");
          menus.forEach((menu) => {
            const btn = document.createElement("button");
            btn.className = "btn btn-outline-primary menu-button";
            btn.textContent = menu.name;
            btn.onclick = () => handleMenuClick(menu.id);
            menuArea.appendChild(btn);
          });
        })
        .catch(() => {
          alert("無法載入選單，請重新登入");
          localStorage.removeItem("token");
          window.location.href = "login.html";
        });

      function handleMenuClick(menuId) {
        if (menuId === "user") {
          loadUsers();
        } else if (menuId === "task") {
          loadTasks();
        }
      }

      function loadUsers() {
        axios.get("http://localhost:8080/api/user", axiosConfig).then((res) => {
          userList = res.data.result;

          let html = `<h4 class="mb-3">使用者列表</h4>
          <button class="btn btn-success mb-3" onclick="showUserForm()">＋ 新增使用者</button>
          <table class="table table-striped table-hover">
            <thead>
              <tr><th>ID</th><th>姓名</th><th>帳號</th><th>角色</th><th style="width: 130px;">操作</th></tr>
            </thead>
            <tbody>`;

          userList.forEach((u) => {
            html += `<tr>
                <td>${u.id}</td>
                <td>${u.name}</td>
                <td>${u.account}</td>
                <td>${
                  u.role === "TEACHER"
                    ? "老師"
                    : u.role === "STUDENT"
                    ? "學生"
                    : "未知"
                }</td>
                <td>
                  <button class="btn btn-sm btn-primary me-2" onclick="showUserForm(${
                    u.id
                  })">編輯</button>
                  <button class="btn btn-sm btn-danger" onclick="deleteUser(${
                    u.id
                  })">刪除</button>
                </td>
              </tr>`;
          });

          html += `</tbody></table>`;
          document.getElementById("content").innerHTML = html;
        });
      }

      function showUserForm(userId) {
        if (!userId) {
          document.getElementById("content").innerHTML = `
            <h4 class="mb-4">新增使用者</h4>
            <form id="userForm" onsubmit="submitUserForm(event)">
              <div class="mb-3">
                <label class="required">姓名</label>
                <input type="text" class="form-control" name="name" placeholder="請輸入姓名" required />
              </div>
              <div class="mb-3">
                <label class="required">帳號</label>
                <input type="text" class="form-control" name="account" placeholder="請輸入帳號" required />
              </div>
              <div class="mb-3">
                <label class="required">密碼</label>
                <input type="password" class="form-control" name="password" placeholder="請輸入密碼" required />
              </div>
              <div class="mb-3">
                <label class="required">角色</label>
                <select class="form-select" name="role" required>
                  <option value="">請選擇角色</option>
                  <option value="TEACHER">老師</option>
                  <option value="STUDENT">學生</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary">新增</button>
              <button type="button" class="btn btn-secondary ms-2" onclick="loadUsers()">取消</button>
            </form>
          `;
        } else {
          const u = userList.find((user) => user.id === userId);
          if (!u) {
            alert("找不到該使用者資料");
            return;
          }

          document.getElementById("content").innerHTML = `
            <h4 class="mb-4">編輯使用者</h4>
            <form id="userForm" onsubmit="submitUserForm(event, ${userId})">
              <div class="mb-3">
                <label class="required">姓名</label>
                <input type="text" class="form-control" name="name" value="${
                  u.name
                }" placeholder="請輸入姓名" required />
              </div>
              <div class="mb-3">
                <label class="required">帳號</label>
                <input type="text" class="form-control" name="account" value="${
                  u.account
                }" readonly />
              </div>
              <div class="mb-3">
                <label>密碼 (不修改請留空)</label>
                <input type="password" class="form-control" name="password" placeholder="若要修改密碼，請輸入新密碼" />
              </div>
              <div class="mb-3">
                <label class="required">角色</label>
                <select class="form-select" name="role" required>
                  <option value="">請選擇角色</option>
                  <option value="TEACHER" ${
                    u.role === "TEACHER" ? "selected" : ""
                  }>老師</option>
                  <option value="STUDENT" ${
                    u.role === "STUDENT" ? "selected" : ""
                  }>學生</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary">儲存</button>
              <button type="button" class="btn btn-secondary ms-2" onclick="loadUsers()">取消</button>
            </form>
          `;
        }
      }

      function submitUserForm(event, userId) {
        event.preventDefault();
        const form = event.target;
        const data = {
          name: form.name.value.trim(),
          account: form.account.value.trim(),
          role: form.role.value,
        };
        if (form.password.value.trim() !== "") {
          data.password = form.password.value.trim();
        }

        if (!data.name) {
          alert("姓名為必填");
          return;
        }
        if (!data.role) {
          alert("角色為必選");
          return;
        }

        if (userId) {
          data.id = userId;
          axios
            .put("http://localhost:8080/api/user", data, axiosConfig)
            .then((res) => {
              alert(res.data.message || "編輯成功");
              loadUsers();
            })
            .catch((err) => {
              alert(err.response?.data?.message || "編輯失敗");
            });
        } else {
          if (!data.password) {
            alert("密碼不可為空");
            return;
          }
          axios
            .post("http://localhost:8080/api/user", data, axiosConfig)
            .then(() => {
              alert("新增成功");
              loadUsers();
            })
            .catch((err) => {
              alert(err.response?.data?.message || "新增失敗");
            });
        }
      }

      function deleteUser(id) {
        if (!confirm("確定要刪除此使用者？")) return;
        axios
          .delete(`http://localhost:8080/api/user/${id}`, axiosConfig)
          .then(() => loadUsers());
      }

      function loadTasks() {
        axios.get("http://localhost:8080/api/task", axiosConfig).then((res) => {
          taskList = res.data.result;
          renderTaskBoard();
        });
      }

      function renderTaskBoard() {
        let html = `
          <h4 class="mb-3">任務列表</h4>
          <div class="task-board">
            <div class="task-header d-flex">
              <div style="width: 50px;"></div>
              <div style="flex: 1;">任務</div>
              <div style="width: 150px; text-align: center;">Owner</div>
              <div style="width: 200px; text-align: center;">Status</div>
              <div style="width: 150px; text-align: center;">日期</div>
              <div style="width: 80px; text-align: center;">操作</div>
            </div>
        `;

        taskList.forEach((task) => {
          const statusOption =
            statusOptions.find((s) => s.value == task.status) ||
            statusOptions[0];
          const userInitial = task.userName ? task.userName : "?";

          html += `
            <div class="task-row">
              <input type="checkbox" class="task-checkbox" ${
                task.status == 2 ? "checked" : ""
              } 
                     onchange="toggleTaskComplete(${task.id}, this.checked)">
              <input type="text" class="task-name" value="${task.taskName}" 
                     onblur="updateTaskName(${task.id}, this.value)"
                     onkeydown="if(event.key==='Enter') this.blur()">
              <div class="task-owner">
                <div class="user-avatar">${userInitial}</div>
              </div>
              <div class="task-status">
                <button class="status-badge ${
                  statusOption.class
                }" onclick="toggleStatusDropdown(${task.id})">
                  ${statusOption.label}
                </button>
                <div id="status-dropdown-${
                  task.id
                }" class="status-dropdown" style="display: none;">
                  ${statusOptions
                    .map(
                      (option) =>
                        `<div class="status-option ${option.class}" onclick="updateTaskStatus(${task.id}, ${option.value})">${option.label}</div>`
                    )
                    .join("")}
                </div>
              </div>
              <div style="width: 150px; text-align: center;">
                <input type="date" class="form-control form-control-sm" value="${
                  task.dueDate || ""
                }" 
                       onchange="updateTaskDate(${
                         task.id
                       }, this.value)" style="font-size: 12px;">
              </div>
              <div class="task-actions">
                <button class="btn btn-sm btn-danger" onclick="deleteTask(${
                  task.id
                })">刪除</button>
              </div>
            </div>
          `;
        });

        html += `
            <div class="task-row add-task-row">
              <div style="width: 50px;"></div>
              <input type="text" class="task-name" placeholder="+ 新增任務" 
                     onkeydown="handleNewTaskKeydown(event)"
                     onblur="handleNewTaskBlur(event)"
                     style="color: #6c757d;">
              <div style="width: 150px;"></div>
              <div style="width: 200px;"></div>
              <div style="width: 150px;"></div>
              <div style="width: 80px;"></div>
            </div>
          </div>
        `;

        document.getElementById("content").innerHTML = html;

        // 點擊其他地方關閉下拉選單
        document.addEventListener("click", function (e) {
          if (!e.target.closest(".task-status")) {
            document
              .querySelectorAll(".status-dropdown")
              .forEach((dropdown) => {
                dropdown.style.display = "none";
              });
          }
        });
      }

      function toggleStatusDropdown(taskId) {
        // 關閉所有其他下拉選單
        document.querySelectorAll(".status-dropdown").forEach((dropdown) => {
          if (dropdown.id !== `status-dropdown-${taskId}`) {
            dropdown.style.display = "none";
          }
        });

        // 切換當前下拉選單
        const dropdown = document.getElementById(`status-dropdown-${taskId}`);
        dropdown.style.display =
          dropdown.style.display === "none" ? "block" : "none";
      }

      function updateTaskStatus(taskId, newStatus) {
        const task = taskList.find((t) => t.id === taskId);
        if (task) {
          task.status = newStatus;
          axios
            .put("http://localhost:8080/api/task", task, axiosConfig)
            .then(() => {
              renderTaskBoard();
            })
            .catch((err) => {
              alert(err.response?.data?.message || "更新失敗");
              loadTasks(); // 重新載入資料
            });
        }
      }

      function updateTaskName(taskId, newName) {
        if (!newName.trim()) return;

        const task = taskList.find((t) => t.id === taskId);
        if (task && task.taskName !== newName.trim()) {
          task.taskName = newName.trim();
          axios
            .put("http://localhost:8080/api/task", task, axiosConfig)
            .then(() => {
              // 更新成功，保持當前顯示
            })
            .catch((err) => {
              alert(err.response?.data?.message || "更新失敗");
              loadTasks(); // 重新載入資料
            });
        }
      }

      function toggleTaskComplete(taskId, isComplete) {
        const newStatus = isComplete ? 2 : 0; // 2=已完成, 0=未開始
        updateTaskStatus(taskId, newStatus);
      }

      function updateTaskDate(taskId, newDate) {
        const task = taskList.find((t) => t.id === taskId);
        if (task) {
          task.dueDate = newDate;
          axios
            .put("http://localhost:8080/api/task", task, axiosConfig)
            .then(() => {
              // 更新成功，保持當前顯示
            })
            .catch((err) => {
              alert(err.response?.data?.message || "更新日期失敗");
              loadTasks(); // 重新載入資料
            });
        }
      }

      function handleNewTaskKeydown(event) {
        if (event.key === "Enter") {
          const taskName = event.target.value.trim();
          if (taskName && taskName !== "+ 新增任務") {
            addNewTask(taskName);
            event.target.value = "";
            event.target.placeholder = "+ 新增任務";
          }
        }
      }

      function handleNewTaskBlur(event) {
        const taskName = event.target.value.trim();
        if (taskName && taskName !== "+ 新增任務") {
          addNewTask(taskName);
          event.target.value = "";
          event.target.placeholder = "+ 新增任務";
        }
      }

      function addNewTask(taskName) {
        if (!taskName) {
          const newTaskName = prompt("請輸入任務名稱:");
          if (!newTaskName || !newTaskName.trim()) return;
          taskName = newTaskName.trim();
        }

        const newTask = {
          taskName: taskName,
          status: 0, // 未開始
          dueDate: new Date().toISOString().split("T")[0], // 今天
        };

        axios
          .post("http://localhost:8080/api/task", newTask, axiosConfig)
          .then(() => {
            loadTasks(); // 重新載入任務列表
          })
          .catch((err) => {
            alert(err.response?.data?.message || "新增任務失敗");
          });
      }

      function deleteTask(id) {
        if (!confirm("確定要刪除此任務？")) return;
        axios
          .delete(`http://localhost:8080/api/task/${id}`, axiosConfig)
          .then(() => loadTasks());
      }
    </script>
  </body>
</html>
