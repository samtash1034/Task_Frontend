<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Schedule Management System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
      body {
        background-color: #f0f2f5;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      .sidebar {
        height: 100vh;
        padding-top: 40px;
        background-color: #ffffff;
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
      }
      .menu-button {
        width: 100%;
        margin-bottom: 12px;
        font-weight: 600;
        border-radius: 8px;
        transition: background-color 0.3s;
      }
      .menu-button:hover {
        background-color: #0d6efd;
        color: white;
      }
      .main-content {
        padding: 40px 50px;
      }
      .header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }
      .page-title {
        font-weight: 700;
        color: #343a40;
        font-size: 2.5rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin: 0;
      }
      .logout-btn {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        border: none;
        color: white;
        padding: 10px 20px;
        border-radius: 25px;
        font-weight: 600;
        transition: all 0.3s;
        box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
      }
      .logout-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(255, 107, 107, 0.4);
        color: white;
      }
      .card {
        border-radius: 12px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        background-color: white;
      }
      table th,
      table td {
        vertical-align: middle !important;
      }
      table thead {
        background-color: #0d6efd;
        color: white;
      }
      table tbody tr:hover {
        background-color: #e7f1ff;
      }
      button.btn-sm {
        border-radius: 6px;
      }
      /* Form styles */
      label {
        font-weight: 600;
      }
      input.form-control:focus,
      select.form-select:focus {
        box-shadow: 0 0 5px #0d6efd;
        border-color: #0d6efd;
      }
      /* Required field indicator */
      .required::after {
        content: " *";
        color: #dc3545;
        font-weight: 700;
      }

      /* Task board styles */
      .task-board {
        border: 2px solid #d0d0d0;
        border-radius: 8px;
        background: white;
        border-collapse: collapse;
      }
      .task-header {
        background-color: #f8f9fa;
        padding: 0;
        border-bottom: 2px solid #d0d0d0;
        font-weight: 700;
        color: #495057;
        display: flex;
      }
      .task-header > div {
        border-right: 2px solid #d0d0d0;
        padding: 15px 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .task-header > div:last-child {
        border-right: none;
      }
      .task-row {
        display: flex;
        align-items: stretch;
        border-bottom: 1px solid #d0d0d0;
        min-height: 60px;
        background-color: white;
        padding: 0;
      }
      .task-row > div,
      .task-row > input {
        border-right: 2px solid #d0d0d0;
        padding: 12px 20px;
        min-height: 60px;
        display: flex;
        align-items: center;
      }
      .task-row > div:last-child {
        border-right: none;
      }
      .task-row:hover {
        background-color: #f8f9fa;
      }
      .task-row:last-child {
        border-bottom: none;
      }
      .task-checkbox {
        width: 12px;
        height: 12px;
        margin: 0 auto;
      }
      .task-name {
        flex: 1;
        font-size: 15px;
        border: none;
        background: transparent;
        padding: 5px;
        border-radius: 4px;
        text-align: left;
      }
      .task-name:focus {
        background-color: #fff;
        border: 1px solid #0d6efd;
        outline: none;
      }
      .task-owner {
        width: 200px;
        text-align: left;
        color: #495057;
        font-weight: 500;
        padding-left: 10px;
      }
      .task-owner i {
        margin-right: 8px;
        color: #6c757d;
      }
      .task-status {
        width: 200px;
        position: relative;
        padding: 0 !important;
        border-right: 2px solid #d0d0d0 !important;
      }
      .status-badge {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        border-radius: 0;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        width: 100%;
        height: 100%;
        text-align: center;
        margin: 0;
      }
      .status-ready {
        background-color: #8b92a6;
        color: white;
      }
      .status-progress {
        background-color: #facc15;
        color: #374151;
      }
      .status-done {
        background-color: #4ade80;
        color: #374151;
      }
      .status-stuck {
        background-color: #f87171;
        color: #374151;
      }
      .status-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        margin-top: 5px;
      }
      .status-option {
        padding: 8px 16px;
        cursor: pointer;
        transition: background-color 0.2s;
        border-radius: 6px;
        margin: 4px;
        font-size: 14px;
      }
      .status-option:hover {
        background-color: #f0f0f0;
      }
      .add-task-row {
        padding: 15px 20px;
        color: #6c757d;
        border-bottom: none;
        background-color: white;
      }
      .add-task-row input:focus {
        color: #495057;
        background-color: #fff;
      }
      .task-actions {
        width: 80px;
        text-align: center;
      }

      /* Delete button icon styles */
      .btn-delete {
        width: 32px;
        height: 32px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s;
      }
      .btn-delete:hover {
        transform: scale(1.1);
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <!-- Left Sidebar -->
        <div class="col-md-2 sidebar">
          <h5 class="text-center mb-4">Menu</h5>
          <div id="menu-area"></div>
        </div>

        <!-- Main Content Area -->
        <div class="col-md-10 main-content">
          <div class="header-section">
            <h1 class="page-title">Schedule</h1>
            <button class="btn logout-btn" onclick="logout()">
              <i class="fas fa-sign-out-alt me-2"></i>Logout
            </button>
          </div>
          <div class="card mt-4">
            <div class="card-body">
              <div id="content"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const token = localStorage.getItem("token");
      if (!token) {
        window.location.href = "login.html";
      }

      const axiosConfig = {
        headers: {
          Authorization: `Bearer ${token}`,
        },
      };

      let userList = [];
      let taskList = [];

      // Status options configuration
      const statusOptions = [
        { value: 0, label: "Not Started", class: "status-ready" },
        { value: 1, label: "In Progress", class: "status-progress" },
        { value: 2, label: "Completed", class: "status-done" },
        { value: 3, label: "Blocked", class: "status-stuck" },
      ];

      function logout() {
        localStorage.removeItem("token");
        window.location.href = "login.html";
      }

      axios
        .get("http://localhost:8080/api/menu", axiosConfig)
        .then((res) => {
          const menus = res.data.result;
          const menuArea = document.getElementById("menu-area");
          menus.forEach((menu) => {
            const btn = document.createElement("button");
            btn.className = "btn btn-outline-primary menu-button";
            btn.textContent = menu.name;
            btn.onclick = () => handleMenuClick(menu.id);
            menuArea.appendChild(btn);
          });
        })
        .catch(() => {
          alert("Unable to load menu, please login again");
          localStorage.removeItem("token");
          window.location.href = "login.html";
        });

      function handleMenuClick(menuId) {
        if (menuId === "user") {
          loadUsers();
        } else if (menuId === "task") {
          loadTasks();
        }
      }

      function loadUsers() {
        axios.get("http://localhost:8080/api/user", axiosConfig).then((res) => {
          userList = res.data.result;

          let html = `<h4 class="mb-3">User Management</h4>
          <button class="btn btn-success mb-3" onclick="showUserForm()">ï¼‹ Add User</button>
          <table class="table table-striped table-hover">
            <thead>
              <tr><th>ID</th><th>Name</th><th>Account</th><th>Role</th><th style="width: 130px;">Actions</th></tr>
            </thead>
            <tbody>`;

          userList.forEach((u) => {
            html += `<tr>
                <td>${u.id}</td>
                <td>${u.name}</td>
                <td>${u.account}</td>
                <td>${
                  u.role === "TEACHER"
                    ? "Teacher"
                    : u.role === "STUDENT"
                    ? "Student"
                    : "Unknown"
                }</td>
                <td>
                  <button class="btn btn-sm btn-primary me-2" onclick="showUserForm(${
                    u.id
                  })">Edit</button>
                  <button class="btn btn-sm btn-danger btn-delete" onclick="deleteUser(${
                    u.id
                  })" title="Delete User">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>`;
          });

          html += `</tbody></table>`;
          document.getElementById("content").innerHTML = html;
        });
      }

      function showUserForm(userId) {
        if (!userId) {
          document.getElementById("content").innerHTML = `
            <h4 class="mb-4">Add User</h4>
            <form id="userForm" onsubmit="submitUserForm(event)">
              <div class="mb-3">
                <label class="required">Name</label>
                <input type="text" class="form-control" name="name" placeholder="Enter name" required />
              </div>
              <div class="mb-3">
                <label class="required">Account</label>
                <input type="text" class="form-control" name="account" placeholder="Enter account" required />
              </div>
              <div class="mb-3">
                <label class="required">Password</label>
                <input type="password" class="form-control" name="password" placeholder="Enter password" required />
              </div>
              <div class="mb-3">
                <label class="required">Role</label>
                <select class="form-select" name="role" required>
                  <option value="">Select role</option>
                  <option value="TEACHER">Teacher</option>
                  <option value="STUDENT">Student</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary">Add</button>
              <button type="button" class="btn btn-secondary ms-2" onclick="loadUsers()">Cancel</button>
            </form>
          `;
        } else {
          const u = userList.find((user) => user.id === userId);
          if (!u) {
            alert("User not found");
            return;
          }

          document.getElementById("content").innerHTML = `
            <h4 class="mb-4">Edit User</h4>
            <form id="userForm" onsubmit="submitUserForm(event, ${userId})">
              <div class="mb-3">
                <label class="required">Name</label>
                <input type="text" class="form-control" name="name" value="${
                  u.name
                }" placeholder="Enter name" required />
              </div>
              <div class="mb-3">
                <label class="required">Account</label>
                <input type="text" class="form-control" name="account" value="${
                  u.account
                }" readonly />
              </div>
              <div class="mb-3">
                <label>Password (leave blank to keep current)</label>
                <input type="password" class="form-control" name="password" placeholder="Enter new password to change" />
              </div>
              <div class="mb-3">
                <label class="required">Role</label>
                <select class="form-select" name="role" required>
                  <option value="">Select role</option>
                  <option value="TEACHER" ${
                    u.role === "TEACHER" ? "selected" : ""
                  }>Teacher</option>
                  <option value="STUDENT" ${
                    u.role === "STUDENT" ? "selected" : ""
                  }>Student</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary">Save</button>
              <button type="button" class="btn btn-secondary ms-2" onclick="loadUsers()">Cancel</button>
            </form>
          `;
        }
      }

      function submitUserForm(event, userId) {
        event.preventDefault();
        const form = event.target;
        const data = {
          name: form.name.value.trim(),
          account: form.account.value.trim(),
          role: form.role.value,
        };
        if (form.password.value.trim() !== "") {
          data.password = form.password.value.trim();
        }

        if (!data.name) {
          alert("Name is required");
          return;
        }
        if (!data.role) {
          alert("Role is required");
          return;
        }

        if (userId) {
          data.id = userId;
          axios
            .put("http://localhost:8080/api/user", data, axiosConfig)
            .then((res) => {
              alert(res.data.message || "Update successful");
              loadUsers();
            })
            .catch((err) => {
              alert(err.response?.data?.message || "Update failed");
            });
        } else {
          if (!data.password) {
            alert("Password cannot be empty");
            return;
          }
          axios
            .post("http://localhost:8080/api/user", data, axiosConfig)
            .then(() => {
              alert("User added successfully");
              loadUsers();
            })
            .catch((err) => {
              alert(err.response?.data?.message || "Failed to add user");
            });
        }
      }

      function deleteUser(id) {
        if (!confirm("Are you sure you want to delete this user?")) return;
        axios
          .delete(`http://localhost:8080/api/user/${id}`, axiosConfig)
          .then(() => loadUsers());
      }

      function loadTasks() {
        axios.get("http://localhost:8080/api/task", axiosConfig).then((res) => {
          taskList = res.data.result;
          renderTaskBoard();
        });
      }

      function renderTaskBoard() {
        let html = `
          <div class="task-board">
            <div class="task-header d-flex">
              <div style="width: 50px; text-align: center;"></div>
              <div style="flex: 1; text-align: center;"><strong>Task</strong></div>
              <div style="width: 200px; text-align: center;"><strong>Owner</strong></div>
              <div style="width: 200px; text-align: center;"><strong>Status</strong></div>
              <div style="width: 150px; text-align: center;"><strong>Due Date</strong></div>
              <div style="width: 80px; text-align: center;"><strong>Actions</strong></div>
            </div>
        `;

        taskList.forEach((task) => {
          const statusOption =
            statusOptions.find((s) => s.value == task.status) ||
            statusOptions[0];

          html += `
            <div class="task-row">
              <div style="width: 50px; text-align: center;">
                <input type="checkbox" class="task-checkbox" ${
                  task.status == 2 ? "checked" : ""
                } 
                       onchange="toggleTaskComplete(${task.id}, this.checked)">
              </div>
              <div style="flex: 1;">
                <input type="text" class="task-name" value="${task.taskName}" 
                       onblur="updateTaskName(${task.id}, this.value)"
                       onkeydown="if(event.key==='Enter') this.blur()">
              </div>
              <div class="task-owner" style="width: 200px;">
                <i class="fas fa-user"></i>${task.userName || "Unassigned"}
              </div>
              <div class="task-status">
                <button class="status-badge ${
                  statusOption.class
                }" onclick="toggleStatusDropdown(${task.id})">
                  ${statusOption.label}
                </button>
                <div id="status-dropdown-${
                  task.id
                }" class="status-dropdown" style="display: none;">
                  ${statusOptions
                    .map(
                      (option) =>
                        `<div class="status-option ${option.class}" onclick="updateTaskStatus(${task.id}, ${option.value})">${option.label}</div>`
                    )
                    .join("")}
                </div>
              </div>
              <div style="width: 150px; text-align: center;">
                <input type="date" class="form-control form-control-sm" value="${
                  task.dueDate || ""
                }" 
                       onchange="updateTaskDate(${
                         task.id
                       }, this.value)" style="font-size: 16px; border: none; background: transparent; font-weight: 500;">
              </div>
              <div class="task-actions" style="width: 80px; text-align: center;">
                <button class="btn btn-sm btn-danger btn-delete" onclick="deleteTask(${
                  task.id
                })" title="Delete Task">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          `;
        });

        html += `
            <div class="task-row add-task-row">
              <div style="width: 50px;"></div>
              <div style="flex: 1;">
                <input type="text" class="task-name" placeholder="+ Add new task" 
                       onkeydown="handleNewTaskKeydown(event)"
                       onblur="handleNewTaskBlur(event)"
                       style="color: #6c757d;">
              </div>
              <div style="width: 200px;"></div>
              <div style="width: 200px;"></div>
              <div style="width: 150px;"></div>
              <div style="width: 80px;"></div>
            </div>
          </div>
        `;

        document.getElementById("content").innerHTML = html;

        // Close dropdown when clicking elsewhere
        document.addEventListener("click", function (e) {
          if (!e.target.closest(".task-status")) {
            document
              .querySelectorAll(".status-dropdown")
              .forEach((dropdown) => {
                dropdown.style.display = "none";
              });
          }
        });
      }

      function toggleStatusDropdown(taskId) {
        // Close all other dropdowns
        document.querySelectorAll(".status-dropdown").forEach((dropdown) => {
          if (dropdown.id !== `status-dropdown-${taskId}`) {
            dropdown.style.display = "none";
          }
        });

        // Toggle current dropdown
        const dropdown = document.getElementById(`status-dropdown-${taskId}`);
        dropdown.style.display =
          dropdown.style.display === "none" ? "block" : "none";
      }

      function updateTaskStatus(taskId, newStatus) {
        const task = taskList.find((t) => t.id === taskId);
        if (task) {
          task.status = newStatus;
          axios
            .put("http://localhost:8080/api/task", task, axiosConfig)
            .then(() => {
              renderTaskBoard();
            })
            .catch((err) => {
              alert(err.response?.data?.message || "Update failed");
              loadTasks(); // Reload data
            });
        }
      }

      function updateTaskName(taskId, newName) {
        if (!newName.trim()) return;

        const task = taskList.find((t) => t.id === taskId);
        if (task && task.taskName !== newName.trim()) {
          task.taskName = newName.trim();
          axios
            .put("http://localhost:8080/api/task", task, axiosConfig)
            .then(() => {
              // Update successful, keep current display
            })
            .catch((err) => {
              alert(err.response?.data?.message || "Update failed");
              loadTasks(); // Reload data
            });
        }
      }

      function toggleTaskComplete(taskId, isComplete) {
        const newStatus = isComplete ? 2 : 0; // 2=Completed, 0=Not Started
        updateTaskStatus(taskId, newStatus);
      }

      function updateTaskDate(taskId, newDate) {
        const task = taskList.find((t) => t.id === taskId);
        if (task) {
          task.dueDate = newDate;
          axios
            .put("http://localhost:8080/api/task", task, axiosConfig)
            .then(() => {
              // Update successful, keep current display
            })
            .catch((err) => {
              alert(err.response?.data?.message || "Failed to update date");
              loadTasks(); // Reload data
            });
        }
      }

      function handleNewTaskKeydown(event) {
        if (event.key === "Enter") {
          const taskName = event.target.value.trim();
          if (taskName && taskName !== "+ Add new task") {
            addNewTask(taskName);
            event.target.value = "";
            event.target.placeholder = "+ Add new task";
          }
        }
      }

      function handleNewTaskBlur(event) {
        const taskName = event.target.value.trim();
        if (taskName && taskName !== "+ Add new task") {
          addNewTask(taskName);
          event.target.value = "";
          event.target.placeholder = "+ Add new task";
        }
      }

      function addNewTask(taskName) {
        if (!taskName) {
          const newTaskName = prompt("Enter task name:");
          if (!newTaskName || !newTaskName.trim()) return;
          taskName = newTaskName.trim();
        }

        const newTask = {
          taskName: taskName,
          status: 0, // Not Started
          dueDate: new Date().toISOString().split("T")[0], // Today
        };

        axios
          .post("http://localhost:8080/api/task", newTask, axiosConfig)
          .then(() => {
            loadTasks(); // Reload task list
          })
          .catch((err) => {
            alert(err.response?.data?.message || "Failed to add task");
          });
      }

      function deleteTask(id) {
        if (!confirm("Are you sure you want to delete this task?")) return;
        axios
          .delete(`http://localhost:8080/api/task/${id}`, axiosConfig)
          .then(() => loadTasks());
      }
    </script>
  </body>
</html>
