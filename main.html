<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>任務與使用者管理系統</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
      body {
        background-color: #f0f2f5;
        font-family: "微軟正黑體", sans-serif;
      }
      .sidebar {
        height: 100vh;
        padding-top: 40px;
        background-color: #ffffff;
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
      }
      .menu-button {
        width: 100%;
        margin-bottom: 12px;
        font-weight: 600;
        border-radius: 8px;
        transition: background-color 0.3s;
      }
      .menu-button:hover {
        background-color: #0d6efd;
        color: white;
      }
      .main-content {
        padding: 40px 50px;
      }
      h2 {
        font-weight: 700;
        margin-bottom: 30px;
        color: #343a40;
      }
      .card {
        border-radius: 12px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
      }
      table th,
      table td {
        vertical-align: middle !important;
      }
      table thead {
        background-color: #0d6efd;
        color: white;
      }
      table tbody tr:hover {
        background-color: #e7f1ff;
      }
      button.btn-sm {
        border-radius: 6px;
      }
      /* 表單樣式 */
      label {
        font-weight: 600;
      }
      input.form-control:focus,
      select.form-select:focus {
        box-shadow: 0 0 5px #0d6efd;
        border-color: #0d6efd;
      }
      /* 必填標示 */
      .required::after {
        content: " *";
        color: #dc3545;
        font-weight: 700;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <div class="row">
        <!-- 左側選單 -->
        <div class="col-md-2 sidebar">
          <h5 class="text-center mb-4">功能選單</h5>
          <div id="menu-area"></div>
        </div>

        <!-- 主內容區 -->
        <div class="col-md-10 main-content">
          <h2 class="text-center">任務與使用者管理系統</h2>
          <div class="card mt-4">
            <div class="card-body">
              <div id="content"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const token = localStorage.getItem("token");
      if (!token) {
        window.location.href = "login.html";
      }

      const axiosConfig = {
        headers: {
          Authorization: `Bearer ${token}`,
        },
      };

      let userList = [];

      axios
        .get("http://localhost:8080/api/menu", axiosConfig)
        .then((res) => {
          const menus = res.data.result;
          const menuArea = document.getElementById("menu-area");
          menus.forEach((menu) => {
            const btn = document.createElement("button");
            btn.className = "btn btn-outline-primary menu-button";
            btn.textContent = menu.name;
            btn.onclick = () => handleMenuClick(menu.id);
            menuArea.appendChild(btn);
          });
        })
        .catch(() => {
          alert("無法載入選單，請重新登入");
          localStorage.removeItem("token");
          window.location.href = "login.html";
        });

      function handleMenuClick(menuId) {
        if (menuId === "user") {
          loadUsers();
        } else if (menuId === "task") {
          loadTasks();
        }
      }

      function loadUsers() {
        axios.get("http://localhost:8080/api/user", axiosConfig).then((res) => {
          userList = res.data.result;

          let html = `<h4 class="mb-3">使用者列表</h4>
          <button class="btn btn-success mb-3" onclick="showUserForm()">＋ 新增使用者</button>
          <table class="table table-striped table-hover">
            <thead>
              <tr><th>ID</th><th>姓名</th><th>帳號</th><th>角色</th><th style="width: 130px;">操作</th></tr>
            </thead>
            <tbody>`;

          userList.forEach((u) => {
            html += `<tr>
                <td>${u.id}</td>
                <td>${u.name}</td>
                <td>${u.account}</td>
                <td>${
                  u.role === "TEACHER"
                    ? "老師"
                    : u.role === "STUDENT"
                    ? "學生"
                    : "未知"
                }</td>
                <td>
                  <button class="btn btn-sm btn-primary me-2" onclick="showUserForm(${
                    u.id
                  })">編輯</button>
                  <button class="btn btn-sm btn-danger" onclick="deleteUser(${
                    u.id
                  })">刪除</button>
                </td>
              </tr>`;
          });

          html += `</tbody></table>`;
          document.getElementById("content").innerHTML = html;
        });
      }

      function showUserForm(userId) {
        if (!userId) {
          document.getElementById("content").innerHTML = `
            <h4 class="mb-4">新增使用者</h4>
            <form id="userForm" onsubmit="submitUserForm(event)">
              <div class="mb-3">
                <label class="required">姓名</label>
                <input type="text" class="form-control" name="name" placeholder="請輸入姓名" required />
              </div>
              <div class="mb-3">
                <label class="required">帳號</label>
                <input type="text" class="form-control" name="account" placeholder="請輸入帳號" required />
              </div>
              <div class="mb-3">
                <label class="required">密碼</label>
                <input type="password" class="form-control" name="password" placeholder="請輸入密碼" required />
              </div>
              <div class="mb-3">
                <label class="required">角色</label>
                <select class="form-select" name="role" required>
                  <option value="">請選擇角色</option>
                  <option value="TEACHER">老師</option>
                  <option value="STUDENT">學生</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary">新增</button>
              <button type="button" class="btn btn-secondary ms-2" onclick="loadUsers()">取消</button>
            </form>
          `;
        } else {
          const u = userList.find((user) => user.id === userId);
          if (!u) {
            alert("找不到該使用者資料");
            return;
          }

          document.getElementById("content").innerHTML = `
            <h4 class="mb-4">編輯使用者</h4>
            <form id="userForm" onsubmit="submitUserForm(event, ${userId})">
              <div class="mb-3">
                <label class="required">姓名</label>
                <input type="text" class="form-control" name="name" value="${
                  u.name
                }" placeholder="請輸入姓名" required />
              </div>
              <div class="mb-3">
                <label class="required">帳號</label>
                <input type="text" class="form-control" name="account" value="${
                  u.account
                }" readonly />
              </div>
              <div class="mb-3">
                <label>密碼 (不修改請留空)</label>
                <input type="password" class="form-control" name="password" placeholder="若要修改密碼，請輸入新密碼" />
              </div>
              <div class="mb-3">
                <label class="required">角色</label>
                <select class="form-select" name="role" required>
                  <option value="">請選擇角色</option>
                  <option value="TEACHER" ${
                    u.role === "TEACHER" ? "selected" : ""
                  }>老師</option>
                  <option value="STUDENT" ${
                    u.role === "STUDENT" ? "selected" : ""
                  }>學生</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary">儲存</button>
              <button type="button" class="btn btn-secondary ms-2" onclick="loadUsers()">取消</button>
            </form>
          `;
        }
      }

      function submitUserForm(event, userId) {
        event.preventDefault();
        const form = event.target;
        const data = {
          name: form.name.value.trim(),
          account: form.account.value.trim(),
          role: form.role.value,
        };
        if (form.password.value.trim() !== "") {
          data.password = form.password.value.trim();
        }

        if (!data.name) {
          alert("姓名為必填");
          return;
        }
        if (!data.role) {
          alert("角色為必選");
          return;
        }

        if (userId) {
          data.id = userId;
          axios
            .put("http://localhost:8080/api/user", data, axiosConfig)
            .then((res) => {
              alert(res.data.message || "編輯成功");
              loadUsers();
            })
            .catch((err) => {
              alert(err.response?.data?.message || "編輯失敗");
            });
        } else {
          if (!data.password) {
            alert("密碼不可為空");
            return;
          }
          axios
            .post("http://localhost:8080/api/user", data, axiosConfig)
            .then(() => {
              alert("新增成功");
              loadUsers();
            })
            .catch((err) => {
              alert(err.response?.data?.message || "新增失敗");
            });
        }
      }

      function deleteUser(id) {
        if (!confirm("確定要刪除此使用者？")) return;
        axios
          .delete(`http://localhost:8080/api/user/${id}`, axiosConfig)
          .then(() => loadUsers());
      }

      function loadTasks() {
        axios.get("http://localhost:8080/api/task", axiosConfig).then((res) => {
          const tasks = res.data.result;
          let html = `<h4 class="mb-3">任務列表</h4>
            <table class="table table-bordered table-hover align-middle">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>任務名稱</th>
                  <th>狀態</th>
                  <th>到期日</th>
                  <th>使用者</th>
                  <th style="width: 100px;">操作</th>
                </tr>
              </thead>
              <tbody>`;
          tasks.forEach((t) => {
            html += `<tr>
              <td>${t.id}</td>
              <td>${t.taskName}</td>
              <td>${t.status == 1 ? "完成" : "未完成"}</td>
              <td>${t.dueDate}</td>
              <td>${t.userName}</td>
              <td>
                <button class="btn btn-sm btn-danger" onclick="deleteTask(${
                  t.id
                })">刪除</button>
              </td>
            </tr>`;
          });
          html += `</tbody></table>`;
          document.getElementById("content").innerHTML = html;
        });
      }

      function deleteTask(id) {
        if (!confirm("確定要刪除此任務？")) return;
        axios
          .delete(`http://localhost:8080/api/task/${id}`, axiosConfig)
          .then(() => loadTasks());
      }
    </script>
  </body>
</html>
